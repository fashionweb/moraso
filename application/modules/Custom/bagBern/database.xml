<?xml version="1.0" encoding="UTF-8"?>
<database xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:noNamespaceSchemaLocation="../../../database/schema.xsd">
    <table engine="InnoDB" name="eavs_e" since="EAVS 1.0">
        <field default="null" name="eid" type="int(10) unsigned" nullable="false" primary="true"
            autoincrement="true" comment="Primary key."/>
        <field default="null" name="identifier" type="varchar(255)" nullable="false"
            comment="Primary name of the entity."/>
    </table>
    <table engine="InnoDB" name="eavs_a" since="EAVS 1.0">
        <field default="null" name="aid" type="int(10) unsigned" nullable="false" primary="true"
            comment="Primary key."/>
        <field default="null" name="identifier" type="varchar(255)" nullable="false"
            comment="Attribute identifier."/>
        <dataset use="ifempty">
            <record>
                <value attribute="aid">1</value>
                <value attribute="identifier">a1</value>
            </record>
            <record>
                <value attribute="aid">2</value>
                <value attribute="identifier">a2</value>
            </record>
            <record>
                <value attribute="aid">3</value>
                <value attribute="identifier">a3</value>
            </record>
            <record>
                <value attribute="aid">4</value>
                <value attribute="identifier">a4</value>
            </record>
            <record>
                <value attribute="aid">5</value>
                <value attribute="identifier">a5</value>
            </record>
            <record>
                <value attribute="aid">6</value>
                <value attribute="identifier">a6</value>
            </record>
            <record>
                <value attribute="aid">7</value>
                <value attribute="identifier">a7</value>
            </record>
            <record>
                <value attribute="aid">8</value>
                <value attribute="identifier">a8</value>
            </record>
            <record>
                <value attribute="aid">9</value>
                <value attribute="identifier">a9</value>
            </record>
        </dataset>
    </table>
    <table engine="InnoDB" name="eavs_v" since="EAVS 1.0">
        <field default="null" name="ent" type="int(10) unsigned" nullable="false" primary="true"
            comment="Entity.">
            <constraint column="eid" ondelete="cascade" onupdate="restrict" table="eavs_e"/>
        </field>
        <field default="null" name="att" type="int(10) unsigned" nullable="false" primary="true"
            comment="Attribute.">
            <constraint column="aid" ondelete="cascade" onupdate="restrict" table="eavs_a"/>
        </field>
        <field default="null" name="src" type="int(10) unsigned" nullable="false" primary="true"
            comment="Source.">
            <constraint column="sid" ondelete="cascade" onupdate="restrict" table="eavs_s"/>
        </field>
        <field default="null" name="charval" type="text" nullable="true"
            comment="String representation of the value."/>
        <field default="1" name="valid" type="int(1) unsigned" nullable="false"/>
        <field default="current_timestamp" name="modified" type="timestamp" nullable="true"/>
    </table>
    <table engine="InnoDB" name="eavs_s" since="EAVS 1.0">
        <field default="null" name="sid" type="int(10) unsigned" nullable="false" primary="true"
            comment="Primary key."/>
        <field default="null" name="identifier" type="varchar(255)" nullable="false"
            comment="Source identifier."/>
        <dataset use="ifempty">
            <record>
                <value attribute="sid">1</value>
                <value attribute="identifier">s1</value>
            </record>
            <record>
                <value attribute="sid">2</value>
                <value attribute="identifier">s2</value>
            </record>
            <record>
                <value attribute="sid">3</value>
                <value attribute="identifier">s3</value>
            </record>
            <record>
                <value attribute="sid">4</value>
                <value attribute="identifier">s4</value>
            </record>
            <record>
                <value attribute="sid">5</value>
                <value attribute="identifier">s5</value>
            </record>
        </dataset>
    </table>
    <table engine="InnoDB" name="eavs_s_trust" since="EAVS 1.0">
        <field default="null" name="source" type="int(10) unsigned" nullable="false" primary="true"
            comment="Source.">
            <constraint column="sid" ondelete="cascade" onupdate="restrict" table="eavs_s"/>
        </field>
        <field default="null" name="trusted" type="int(10) unsigned" nullable="false" primary="true"
            comment="Trusted source.">
            <constraint column="sid" ondelete="cascade" onupdate="restrict" table="eavs_s"/>
        </field>
        <field default="null" name="prio" type="int(10) unsigned" nullable="false" primary="true"
            comment="Level of trust."/>
        <dataset use="ifempty">
            <record>
                <value attribute="source">1</value>
                <value attribute="trusted">1</value>
                <value attribute="prio">1</value>
            </record>
            <record>
                <value attribute="source">1</value>
                <value attribute="trusted">3</value>
                <value attribute="prio">2</value>
            </record>
            <record>
                <value attribute="source">1</value>
                <value attribute="trusted">5</value>
                <value attribute="prio">3</value>
            </record>
            <record>
                <value attribute="source">2</value>
                <value attribute="trusted">2</value>
                <value attribute="prio">1</value>
            </record>
            <record>
                <value attribute="source">2</value>
                <value attribute="trusted">1</value>
                <value attribute="prio">2</value>
            </record>
            <record>
                <value attribute="source">3</value>
                <value attribute="trusted">3</value>
                <value attribute="prio">1</value>
            </record>
            <record>
                <value attribute="source">4</value>
                <value attribute="trusted">1</value>
                <value attribute="prio">1</value>
            </record>
            <record>
                <value attribute="source">4</value>
                <value attribute="trusted">4</value>
                <value attribute="prio">2</value>
            </record>
            <record>
                <value attribute="source">5</value>
                <value attribute="trusted">5</value>
                <value attribute="prio">1</value>
            </record>
            <record>
                <value attribute="source">5</value>
                <value attribute="trusted">2</value>
                <value attribute="prio">2</value>
            </record>
        </dataset>
    </table>
    <table engine="InnoDB" name="eavs_v_prio_m" since="EAVS 1.0">
        <field default="null" name="ent" type="int(10) unsigned" nullable="false" primary="true">
            <constraint column="eid" ondelete="cascade" onupdate="restrict" table="eavs_e"/>
        </field>
        <field default="null" name="att" type="int(10) unsigned" nullable="false" primary="true">
            <constraint column="aid" ondelete="cascade" onupdate="restrict" table="eavs_a"/>
        </field>
        <field default="null" name="src" type="int(10) unsigned" nullable="false" primary="true">
            <constraint column="sid" ondelete="cascade" onupdate="restrict" table="eavs_s"/>
        </field>
        <field default="null" name="prio" type="int(10) unsigned" nullable="false"/>
        <field default="current_timestamp" name="modified" type="timestamp" nullable="false"/>
    </table>
    <view name="eavs_v_prio"><![CDATA[
        select
            v.ent,
            v.att,
            s.source src,
            min(s.prio) prio,
            max(v.created) modified
        from 
            _eavs_v v, 
            _eavs_s_trust s
        where 
            v.src = s.trusted
            and v.modified > (select modified from _eavs_v_prio_m_modified)
        group by
            v.ent,
            v.att,
            s.source
        ]]></view>
    <view name="eavs_v_val"><![CDATA[
        select
            v.*,
            s.trusted ssrc,
            s.source strust,
            s.prio
        from 
            _eavs_v v, 
            _eavs_s_trust s
        where 
            v.src = s.trusted
        ]]></view>
    <view name="eavs_v_trusted"><![CDATA[
        select 
            v.*
        from
            _eavs_v_val v,
            _eavs_v_prio_m p
        where
            v.ent = p.ent
            and v.att = p.att
            and v.prio = p.prio
            and v.strust = p.src
        ]]></view>
    <view name="eavs_v_prio_m_modified"><![CDATA[
        select max(modified) modified from _eavs_v_prio_m
        ]]></view>
    <!--
        drop trigger logEavsValueData
        //
        create trigger logEavsValueData after update on ait_eavs_v
        for each row begin
        insert into ait_eavs_v_old (ent, att, src, charval, modified) values (old.ent, old.att, old.src, old.charval, old.modified);
        delete from ait_eavs_v_prio_m where ent = old.ent and att = old.att and src = old.src;
        replace into ait_eavs_v_prio_m select * from ait_eavs_v_prio;
        end;
        //
        
        drop trigger logEavsValueData2
        //
        create trigger logEavsValueData2 after delete on ait_eavs_v
        for each row begin
        insert into ait_eavs_v_old (ent, att, src, charval, modified) values (old.ent, old.att, old.src, old.charval, old.modified);
        delete from ait_eavs_v_prio_m where ent = old.ent;
        replace into ait_eavs_v_prio_m 
        select
        v.ent,
        v.att,
        s.source src,
        min(s.prio) prio,
        max(v.modified) modified
        from 
        ait_eavs_v v, 
        ait_eavs_s_trust s
        where 
        v.src = s.trusted
        and v.ent = old.ent 
        group by
        v.ent,
        v.att,
        s.source;
        end;
        //
        
        drop trigger logEavsValueData3
        //
        create trigger logEavsValueData3 after insert on ait_eavs_v
        for each row begin
        delete from ait_eavs_v_prio_m where ent = new.ent and att = new.att and src = new.src;
        replace into ait_eavs_v_prio_m select * from ait_eavs_v_prio;
        end;
        //         
    -->
</database>
