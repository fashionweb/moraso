<?xml version="1.0" encoding="UTF-8"?>
<database xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:noNamespaceSchemaLocation="../../../database/schema.xsd">
    <table engine="InnoDB" name="eavs_e" since="EAVS 1.0">
        <field default="null" name="eid" type="int(10) unsigned" nullable="false" primary="true"
            autoincrement="true" comment="Primary key."/>
        <field default="null" name="identifier" type="varchar(255)" nullable="false"
            comment="Primary name of the entity."/>
        <field default="current_timestamp" name="modified" type="timestamp" nullable="true"/>
    </table>
    <table engine="InnoDB" name="eavs_view_source_1" since="EAVS 1.0">
        <field default="null" name="eid" type="int(10) unsigned" primary="true">
            <constraint column="eid" ondelete="cascade" onupdate="restrict" table="eavs_e"/>
        </field>
        <field default="null" name="identifier" type="varchar(255)" nullable="false"/>
        <field default="null" name="modified" type="timestamp" nullable="false"/>
        <field default="null" name="a1" type="text" nullable="true"/>
        <field default="null" name="a2" type="text" nullable="true"/>
        <field default="null" name="a3" type="text" nullable="true"/>
        <field default="null" name="a4" type="text" nullable="true"/>
        <field default="null" name="a5" type="text" nullable="true"/>
        <field default="null" name="a6" type="text" nullable="true"/>
        <field default="null" name="a7" type="text" nullable="true"/>
        <field default="null" name="a8" type="text" nullable="true"/>
        <field default="null" name="a9" type="text" nullable="true"/>
    </table>
    <table engine="InnoDB" name="eavs_a" since="EAVS 1.0">
        <field default="null" name="aid" type="int(10) unsigned" nullable="false" primary="true"
            comment="Primary key."/>
        <field default="null" name="identifier" type="varchar(255)" nullable="false"
            comment="Attribute identifier."/>
        <dataset use="ifempty">
            <record>
                <value attribute="aid">1</value>
                <value attribute="identifier">a1</value>
            </record>
            <record>
                <value attribute="aid">2</value>
                <value attribute="identifier">a2</value>
            </record>
            <record>
                <value attribute="aid">3</value>
                <value attribute="identifier">a3</value>
            </record>
            <record>
                <value attribute="aid">4</value>
                <value attribute="identifier">a4</value>
            </record>
            <record>
                <value attribute="aid">5</value>
                <value attribute="identifier">a5</value>
            </record>
            <record>
                <value attribute="aid">6</value>
                <value attribute="identifier">a6</value>
            </record>
            <record>
                <value attribute="aid">7</value>
                <value attribute="identifier">a7</value>
            </record>
            <record>
                <value attribute="aid">8</value>
                <value attribute="identifier">a8</value>
            </record>
            <record>
                <value attribute="aid">9</value>
                <value attribute="identifier">a9</value>
            </record>
        </dataset>
    </table>
    <table engine="InnoDB" name="eavs_v" since="EAVS 1.0">
        <field default="null" name="ent" type="int(10) unsigned" nullable="false" primary="true"
            comment="Entity.">
            <constraint column="eid" ondelete="cascade" onupdate="restrict" table="eavs_e"/>
        </field>
        <field default="null" name="att" type="int(10) unsigned" nullable="false" primary="true"
            comment="Attribute.">
            <constraint column="aid" ondelete="cascade" onupdate="restrict" table="eavs_a"/>
        </field>
        <field default="null" name="src" type="int(10) unsigned" nullable="false" primary="true"
            comment="Source.">
            <constraint column="sid" ondelete="cascade" onupdate="restrict" table="eavs_s"/>
        </field>
        <field default="null" name="charval" type="text" nullable="true"
            comment="String representation of the value."/>
        <field default="current_timestamp" name="modified" type="timestamp" nullable="true"/>
    </table>
    <table engine="InnoDB" name="eavs_v_old" since="EAVS 1.0">
        <field default="null" name="ent" type="int(10) unsigned" nullable="false" primary="true"
            comment="Entity."/>
        <field default="null" name="att" type="int(10) unsigned" nullable="false" primary="true"
            comment="Attribute."/>
        <field default="null" name="src" type="int(10) unsigned" nullable="false" primary="true"
            comment="Source."/>
        <field default="null" name="charval" type="text" nullable="true"
            comment="String representation of the value."/>
        <field default="current_timestamp" name="modified" type="timestamp" nullable="true"
            primary="true"/>
    </table>
    <table engine="InnoDB" name="eavs_s" since="EAVS 1.0">
        <field default="null" name="sid" type="int(10) unsigned" nullable="false" primary="true"
            comment="Primary key."/>
        <field default="null" name="identifier" type="varchar(255)" nullable="false"
            comment="Source identifier."/>
        <dataset use="ifempty">
            <record>
                <value attribute="sid">1</value>
                <value attribute="identifier">s1</value>
            </record>
            <record>
                <value attribute="sid">2</value>
                <value attribute="identifier">s2</value>
            </record>
            <record>
                <value attribute="sid">3</value>
                <value attribute="identifier">s3</value>
            </record>
            <record>
                <value attribute="sid">4</value>
                <value attribute="identifier">s4</value>
            </record>
            <record>
                <value attribute="sid">5</value>
                <value attribute="identifier">s5</value>
            </record>
        </dataset>
    </table>
    <table engine="InnoDB" name="eavs_s_trust" since="EAVS 1.0">
        <field default="null" name="source" type="int(10) unsigned" nullable="false" primary="true"
            comment="Source.">
            <constraint column="sid" ondelete="cascade" onupdate="restrict" table="eavs_s"/>
        </field>
        <field default="null" name="trusted" type="int(10) unsigned" nullable="false" primary="true"
            comment="Trusted source.">
            <constraint column="sid" ondelete="cascade" onupdate="restrict" table="eavs_s"/>
        </field>
        <field default="null" name="prio" type="int(10) unsigned" nullable="false" primary="true"
            comment="Level of trust."/>
        <dataset use="ifempty">
            <record>
                <value attribute="source">1</value>
                <value attribute="trusted">1</value>
                <value attribute="prio">1</value>
            </record>
            <record>
                <value attribute="source">1</value>
                <value attribute="trusted">3</value>
                <value attribute="prio">2</value>
            </record>
            <record>
                <value attribute="source">1</value>
                <value attribute="trusted">5</value>
                <value attribute="prio">3</value>
            </record>
            <record>
                <value attribute="source">2</value>
                <value attribute="trusted">2</value>
                <value attribute="prio">1</value>
            </record>
            <record>
                <value attribute="source">2</value>
                <value attribute="trusted">1</value>
                <value attribute="prio">2</value>
            </record>
            <record>
                <value attribute="source">3</value>
                <value attribute="trusted">3</value>
                <value attribute="prio">1</value>
            </record>
            <record>
                <value attribute="source">4</value>
                <value attribute="trusted">1</value>
                <value attribute="prio">1</value>
            </record>
            <record>
                <value attribute="source">4</value>
                <value attribute="trusted">4</value>
                <value attribute="prio">2</value>
            </record>
            <record>
                <value attribute="source">5</value>
                <value attribute="trusted">5</value>
                <value attribute="prio">1</value>
            </record>
            <record>
                <value attribute="source">5</value>
                <value attribute="trusted">2</value>
                <value attribute="prio">2</value>
            </record>
        </dataset>
    </table>
    <table engine="InnoDB" name="eavs_v_prio_m" since="EAVS 1.0">
        <field default="null" name="ent" type="int(10) unsigned" nullable="false" primary="true">
            <constraint column="eid" ondelete="cascade" onupdate="restrict" table="eavs_e"/>
        </field>
        <field default="null" name="att" type="int(10) unsigned" nullable="false" primary="true">
            <constraint column="aid" ondelete="cascade" onupdate="restrict" table="eavs_a"/>
        </field>
        <field default="null" name="src" type="int(10) unsigned" nullable="false" primary="true">
            <constraint column="sid" ondelete="cascade" onupdate="restrict" table="eavs_s"/>
        </field>
        <field default="null" name="prio" type="int(10) unsigned" nullable="false"/>
        <field default="current_timestamp" name="modified" type="timestamp" nullable="false"/>
    </table>
    <table engine="InnoDB" name="eavs_v_trusted_m" since="EAVS 1.0">
        <field default="null" name="ent" type="int(10) unsigned" nullable="false" primary="true">
            <constraint column="eid" ondelete="cascade" onupdate="restrict" table="eavs_e"/>
        </field>
        <field default="null" name="att" type="int(10) unsigned" nullable="false" primary="true"/>
        <field default="null" name="src" type="int(10) unsigned" nullable="false" primary="true"/>
        <field default="null" name="tsrc" type="int(10) unsigned" nullable="false" primary="true"/>
        <field default="null" name="charval" type="text" nullable="true"/>
        <field default="null" name="modified" type="timestamp" nullable="false"/>
        <index columns="modified" name="modified" type="index"/>
    </table>
    <function name="updateEavs"><![CDATA[
        create procedure updateEavs()
        begin
            insert into ait_eavs_v_prio_m select * from ait_eavs_v_prio;
            insert into ait_eavs_v_trusted_m (ent, att, src, tsrc, charval, modified)
                select
                    t.ent,
                    t.att,
                    t.src,
                    t.strust,
                    t.charval,
                    t.modified
                from ait_eavs_v_trusted t
                left join ait_eavs_v_trusted_m m on t.ent = m.ent and t.att = m.att and t.src = m.src and t.strust = m.tsrc
                where
                    m.ent is null;
            insert into ait_eavs_view_source_1
                select
                    e.eid,
                    e.identifier,
                    e.modified,
                    a1.charval a1,
                    a2.charval a2,
                    a3.charval a3,
                    a4.charval a4,
                    a5.charval a5,
                    a6.charval a6,
                    a7.charval a7,
                    a8.charval a8,
                    a9.charval a9
                from ait_eavs_e e
                left join ait_eavs_v_trusted_m a1 on e.eid = a1.ent and a1.att = 1 and a1.tsrc = 1
                left join ait_eavs_v_trusted_m a2 on e.eid = a2.ent and a2.att = 2 and a2.tsrc = 1
                left join ait_eavs_v_trusted_m a3 on e.eid = a3.ent and a3.att = 3 and a3.tsrc = 1
                left join ait_eavs_v_trusted_m a4 on e.eid = a4.ent and a4.att = 4 and a4.tsrc = 1
                left join ait_eavs_v_trusted_m a5 on e.eid = a5.ent and a5.att = 5 and a5.tsrc = 1
                left join ait_eavs_v_trusted_m a6 on e.eid = a6.ent and a6.att = 6 and a6.tsrc = 1
                left join ait_eavs_v_trusted_m a7 on e.eid = a7.ent and a7.att = 7 and a7.tsrc = 1
                left join ait_eavs_v_trusted_m a8 on e.eid = a8.ent and a8.att = 8 and a8.tsrc = 1
                left join ait_eavs_v_trusted_m a9 on e.eid = a9.ent and a9.att = 9 and a9.tsrc = 1
                left join ait_eavs_view_source_1 m on e.eid = m.eid
                where
                    m.eid is null;
        end]]></function>
    <view name="eavs_v_prio"><![CDATA[
        select 
            v.ent ent,
            v.att att,
            s.source src,
            min(s.prio) prio,
            max(v.modified) modified 
        from 
            _eavs_v v, 
            _eavs_e e,
            _eavs_s_trust s
        where 
            v.src = s.trusted 
            and e.eid = v.ent
            and e.modified > (
                select 
                    if(max(modified) is null, '1970-01-01 00:00:00', max(modified))
                from _eavs_v_prio_m
                ) 
        group by 
            v.ent,
            v.att,
            s.source
        ]]></view>
    <view name="eavs_v_val"><![CDATA[
        select 
            v.ent ent,
            v.att att,
            v.src src,
            v.charval charval,
            v.modified modified,
            s.trusted ssrc,
            s.source strust,
            s.prio prio 
        from 
            _eavs_v v,
            _eavs_s_trust s
        where
            v.src = s.trusted
        ]]></view>
    <view name="eavs_v_trusted"><![CDATA[
        select 
            v.ent ent,
            v.att att,
            v.src src,
            v.charval charval,
            v.modified modified,
            v.ssrc ssrc,
            v.strust strust,
            v.prio prio 
        from 
            _eavs_v_val v, 
            _eavs_v_prio_m p 
        where 
            v.ent = p.ent 
            and v.att = p.att
            and v.prio = p.prio
            and v.strust = p.src
        ]]></view>
    <trigger name="logEavsValueData"><![CDATA[
        create trigger logEavsValueData after update on _eavs_v
            for each row begin
                insert into _eavs_v_old (ent, att, src, charval, modified) values (old.ent, old.att, old.src, old.charval, now());
                delete from _eavs_v_prio_m where ent = old.ent or ent = new.ent;
                delete from _eavs_v_trusted_m where ent = old.ent or ent = new.ent;
                delete from _eavs_view_source_1 where eid = old.ent or eid = new.ent;
                update _eavs_e set modified = now() where eid = old.ent;
                update _eavs_e set modified = now() where eid = new.ent;
            end;
        ]]></trigger>
    <trigger name="logEavsValueData2"><![CDATA[
        create trigger logEavsValueData2 after delete on _eavs_v
            for each row begin
                insert into _eavs_v_old (ent, att, src, charval, modified) values (old.ent, old.att, old.src, old.charval, now());
                delete from _eavs_v_prio_m where ent = old.ent;
                delete from _eavs_v_trusted_m where ent = old.ent;
                delete from _eavs_view_source_1 where eid = old.ent;
                update _eavs_e set modified = now() where eid = old.ent;
            end;
        ]]></trigger>
    <trigger name="logEavsValueData3"><![CDATA[
        create trigger logEavsValueData3 after insert on _eavs_v
            for each row begin
                delete from _eavs_v_prio_m where ent = new.ent;
                delete from _eavs_v_trusted_m where ent = new.ent;
                delete from _eavs_view_source_1 where eid = new.ent;
                update _eavs_e set modified = now() where eid = new.ent;
            end;
        ]]></trigger>
</database>
