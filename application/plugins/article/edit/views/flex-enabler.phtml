(function( $ ){
	$.fn.enableFlexEditor = function() {

		var scrollTimerId;
		var scrolling = false;
		var bboffset = 0;

		this.find('.flexcontent').mouseover(function(e){
			e.stopPropagation();
		});
		
		/*
		 * As mouse events are not propagated above the current document
		 * boundaries this must be done explicitly.
		 */
		this.find('ul.flexcontent').on({
			mousemove: function(event) {
				$(parent.document).trigger(event);
			},
			mouseup: function(event) {
				$(parent.document).trigger(event);
			}
		});
		
		this.find('.buttonbar').css({
			'display': 'none',
			'position': 'absolute',
			'padding': '2px 0 2px 2px',
			'cursor': 'move',
			'background-color': '#DDD',
			'position': 'absolute',
			'top': '-26px',
			'height': '26px',
			'width': '100%'
		});
		
		this.find('.buttonbar .flex-ui-button').css({
			'padding': '0 3px 0 3px',
			'margin': '0 1px 0 1px',
			'border': '1px solid #CCC',
			'-moz-border-radius': '4px',
			'-webkit-border-radius': '4px',
			'-khtml-border-radius': '4px',
			'border-radius': '4px',
			'width': '24px',
			'height': '24px',
			'float': 'left',
			'background-color': 'white',
			'cursor': 'pointer'
		});
		
		this.find('.buttonbar span.add').css({
			'display': 'block',
			'height': '16px',
			'width': '16px',
			'background-image': 'url(/adm/images/flex-ui-icons.png)',
			'background-position': '-16px -128px'
		});
		
		this.find('.buttonbar span.edit').css({
			'display': 'block',
			'height': '16px',
			'width': '16px',
			'background-image': 'url(/adm/images/flex-ui-icons.png)',
			'background-position': '-64px -112px'
		});
		
		this.find('.buttonbar span.trash').css({
			'display': 'block',
			'height': '16px',
			'width': '16px',
			'background-image': 'url(/adm/images/flex-ui-icons.png)',
			'background-position': '-176px -96px'
		});
		
		this.find('ul.flexcontent > li').hover(
			function() {
				$(this).find('div.buttonbar').css({
					'display': 'block',
					'opacity': '0.8'
				});
			},
			function() {
				$(this).find('div.buttonbar').css('display', 'none');
			});
		
		this.find('ul.flexcontent').sortable({
			axis: 'y',
			handle: 'div.buttonbar',
			update: function(event, ui) {
				var editor = $(this).closest('.flexeditor');
				var modules = $(this).find('li > a.module').map(function(index) {
					return $(this).attr('href');
				}).get();
				var id = $(this).closest('.flexeditor').attr('id');
				var regex = /([^-]*)-([^-]*)-(\d*)/;
  				regex.exec(id);
				var index = RegExp.$2;
				var idart = RegExp.$3;
				$.post($('#edit-iframe-' + idart).attr('src'), {
					renderOnly: "Flex:" + index,
					edit: 1,
					modules: modules
				},function(data) {
					var flexcontent = $('#' + id, data).html();
					editor.html(flexcontent);
					$(document).trigger('edit-page-content', [$('#edit-iframe-' + idart)]);
				});
			},
			start: function(event, ui) {
  				/([^-]*)-([^-]*)-(\d*)/.exec($(this).closest('.flexeditor').attr('id'));
				var cframe =  $('#edit-iframe-' + RegExp.$3);
				var sbar = cframe.contents().find('body');
				var distance = 0;
				var maxOffset = $(this).closest('div').offset().top + $(this).height() - cframe.height() + 50;
				var minOffset = $(this).closest('div').offset().top;
				$(this).bind('mousemove', function(e) {				
					if (!scrolling && (sbar.scrollTop() + cframe.height() - e.pageY < 100 || e.pageY - sbar.scrollTop() < 100)) {
						scrolling = true;
						scrollTimerId = window.setInterval(function() {
							if (distance > 0) {
								sbar.scrollTop(Math.min(sbar.scrollTop() + distance, maxOffset));
							} else {
								sbar.scrollTop(Math.max(sbar.scrollTop() + distance, minOffset));
							}
							if (sbar.scrollTop() >= maxOffset || sbar.scrollTop() <= minOffset) {
								distance = 0;
								scrolling = false;
								window.clearInterval(scrollTimerId);
								return;
							}
						}, 10);
					}
					if (sbar.scrollTop() + cframe.height() - e.pageY < 100) {
						distance = 200 / (sbar.scrollTop() + cframe.height() - e.pageY);
					} else if (e.pageY - sbar.scrollTop() < 100) {
						distance = -200 / (e.pageY - sbar.scrollTop());
					} else {
						distance = 0;
						scrolling = false;
						window.clearInterval(scrollTimerId);
					}
				});
			},
			stop: function(event, ui) {
				window.clearInterval(scrollTimerId);
				$(this).unbind('mousemove');
			}
		});
	};
})( jQuery );
