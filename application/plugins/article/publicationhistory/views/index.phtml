Ext.ux.IFrameComponent = Ext.extend(Ext.BoxComponent, {
     onRender : function(ct, position){
          this.el = ct.createChild({tag: 'iframe', id: this.id, frameBorder: 0, src: this.url});
     }
});

choosen_publication_iframe = new Ext.ux.IFrameComponent({id: 'preview-iframe-choosen', url: null});
            
var publications = new Ext.grid.GridPanel({
    id: 'publications',
	store: new Ext.data.JsonStore({
        autoDestroy: true,
        url: '<?php echo $this->url(array('plugin' => 'publicationhistory', 'paction' => 'store'), 'aplugin'); ?>',
        remoteSort: false,
        storeId: 'publicationsStore',
        idProperty: 'pubid',
        root: 'data',
        fields: [{name: 'pubid', type: 'int'}, 'user', {name: 'pubtime', type: 'date', dateFormat: 'Y-m-d H:i:s'}, 'status'],
        baseParams: {
        	idart: <?php echo $this->idart; ?>
        }
    }),
    columns: [
        {dataIndex: 'pubtime', header: '<?php echo Aitsu_Translate :: translate('Date'); ?>', menuDisabled: true, sortable: true, renderer: Ext.util.Format.dateRenderer('d.m.Y H:i:s')},
        {dataIndex: 'user', header: '<?php echo Aitsu_Translate :: translate('User'); ?>', menuDisabled: true, sortable: true},
        {dataIndex: 'status', header: '<?php echo Aitsu_Translate :: translate('Status'); ?>', menuDisabled: true, sortable: true, renderer: function(value, metaData, record, rowIndex, colIndex, store) {
            if (record.get('status') != 1) {
                return '<span style="color:red;"><?php echo Aitsu_Translate :: translate('unpublished'); ?></span>';
	    } else {
                return '<span style="color:green;"><?php echo Aitsu_Translate :: translate('published'); ?></span>';
	    }
	}}
	],
	viewConfig: {
		forceFit: true,
		autoFill: true
	},
	border: false,
	listeners: {
		render: {
			fn: function(){
				this.getStore().load();
			}
		},
                rowclick : function(grid,rowIndex,e) {               
                                                               
                    var pubid = Ext.getCmp('publications').selModel.getSelected().data.pubid;
            
                    Ext.Ajax.request({
                        url: '<?php echo $this->url(array('plugin' => 'publicationhistory', 'paction' => 'activate'), 'aplugin'); ?>',
			success: function(response, opts) {
                            var rsp = Ext.decode(response.responseText);
                            if (rsp.success) {
                                Ext.getCmp('publications').getStore().reload();
                                       
                                // Edit bereich muss noch neu geladen werden
                                
                                Ext.get('preview-iframe-choosen').set({
                                    src: '<?php echo Aitsu_Registry :: get()->config->sys->mainDir; ?>adm/preview/<?php echo $this->idartlang; ?>'
                                });
                            }
			},
			params: { 
                            idart: <?php echo $this->idart; ?>,
                            idartlang: <?php echo $this->idartlang; ?>,
                            pubid: pubid
			}
                    });					 			
		}
	}
});

var publicationView = {
    layout: {
        type: 'vbox',
        pack: 'start',
        align: 'stretch'
    },
    defaults: {
        frame: false
    },
    border: false,
    items: [{
        title: 'current Edit',
        flex: 1,
        xtype: 'panel',
        layout:'fit',
        items: [choosen_publication_iframe],
        tbar: {
            items: [{
                tooltip: '<?php echo Aitsu_Translate :: translate('Publish'); ?>',
	        iconCls: 'page-published',
	        handler: function(b, e) {
                    Ext.MessageBox.show({
					 	title: '<?php echo $this->translate('Publish'); ?>',
					 	msg: '<?php echo $this->translate('Are you sure to publish the selected publication?'); ?>',
					 	buttons: Ext.MessageBox.OKCANCEL,
					 	fn: function(result) {
                                                
                                                var pubid = Ext.getCmp('publications').selModel.getSelected().data.pubid;
            
					 	if (result == 'ok') {
				            	Ext.Ajax.request({
				            		url: '<?php echo $this->url(array('plugin' => 'publicationhistory', 'paction' => 'publish'), 'aplugin'); ?>',
				            		success: function(response, opts) {
				            			var rsp = Ext.decode(response.responseText);
				            			if (rsp.success) {
					            			Ext.getCmp('publications').getStore().reload();
				            			}
				            		},
				            		params: { 
                                                                idart: <?php echo $this->idart; ?>,
                                                                idartlang: <?php echo $this->idartlang; ?>,
                                                                pubid: pubid
				            		}
				            	});					 			
					 		}
					 	}
					 });
	        }
            }]
	}
    }]
};

Ext.getCmp('page-edit-tab').add({
    id: 'article-plugin-publicationhistory',
    title: '<?php echo Aitsu_Translate :: translate('Publication History'); ?>',
    layout: 'border',
    items: [{
        title: 'Publications',
	region: 'west',
	width: 400,
	layout: 'fit',
	split: true,
	items: publications
    }, {
	region: 'center',
	layout: 'fit',
	split: true,
	items: publicationView
    }]
});